<?php

/**
 * @file
 * Hook implementations for Boston College.
 */

define('BOSTON_COLLEGE_ARCHIVAL_PDF_DATASTREAM_ID', 'ARCHIVE-PDF');
define('BOSTON_COLLEGE_VIDEO_CONTENT_MODEL', 'islandora:BCVideo');
define('BOSTON_COLLEGE_VIDEO_FORM', 'BC Video MODS Form');

/**
 * Implements hook_menu_alter().
 */
function boston_college_menu_alter(&$items) {
  // Swap in our alternate form.
  $items['islandora/object/%islandora_object/islandora_scholar_upload'] = array(
    'file path' => drupal_get_path('module', 'boston_college'),
    'file' => 'includes/document.tab.inc',
    'page callback' => 'boston_college_document_view',
  ) + $items['islandora/object/%islandora_object/islandora_scholar_upload'];
}

/**
 * Implements hook_islandora_ingest_steps_alter().
 */
function boston_college_islandora_ingest_steps_alter(&$steps, &$form_state) {
  unset($steps['islandora_scholar_file_upload']);
}

/**
 * Implements hook_islandora_ingest_steps().
 */
function boston_college_islandora_ingest_steps(array $form_state) {
  $models = boston_college_citation_models();

  $steps = array();
  $shared_storage = islandora_ingest_form_get_shared_storage($form_state);

  if (array_intersect($models, $shared_storage['models'])) {
    $steps['boston_college_document_upload'] = array(
      'weight' => 10,
      'type' => 'form',
      'form_id' => 'boston_college_document_upload_ingest_step_form',
      'module' => 'boston_college',
      'file' => 'includes/document.ingest_step.inc',
    );
  }

  return $steps;
}

/**
 * Alter the image_field_caption field to look like it takes a URL.
 */
function boston_college_field_widget_form_alter(&$element, &$form_state, $context) {
  // Add display_field setting to field because file_field_widget_form() assumes
  // it is set.
  $instance = $context['instance'];
  $settings = $instance['settings'];

  if (isset($settings['image_field_caption']) && $instance['widget']['type'] == 'image_image' && $settings['image_field_caption']) {
    foreach (element_children($element) as $delta) {
      // Add all extra functionality provided by the image widget.
      $element[$delta]['#process'][] = 'boston_college_image_field_caption_widget_process';
    }
  }
}

/**
 * An element #process callback for the image_image field type.
 *
 * Expands the image_image type to include the alt and title fields.
 */
function boston_college_image_field_caption_widget_process($element, &$form_state, $form) {
  // Add the additional alt and title fields.
  $element['image_field_caption']['#title'] = t('Link');
  $element['image_field_caption']['#base_type'] = 'textfield';
  $element['image_field_caption']['#format'] = 'plain_text';
  $element['image_field_caption']['#description'] = t('The link the image will redirect to.');
  return $element;
}

/**
 * Implements hook_islandora_derivative().
 */
function boston_college_islandora_derivative(AbstractObject $object = NULL) {
  $mod_path = drupal_get_path('module', 'boston_college');
  $derivatives = array(
    array(
      'source_dsid' => 'MODS',
      'destination_dsid' => NULL,
      'weight' => 0,
      'function' => array(
        'boston_college_update_object_label_from_mods_derivative',
      ),
      'file' => "$mod_path/includes/derivatives.inc",
    ),
  );

  $models = boston_college_citation_models();
  if (array_intersect($models, $object->models)) {
    module_load_include('inc', 'islandora_scholar', 'includes/utilities');
    $derivatives[] = array(
      'source_dsid' => BOSTON_COLLEGE_ARCHIVAL_PDF_DATASTREAM_ID,
      'destination_dsid' => 'PDF',
      'function' => array(
        'boston_college_build_pdf',
      ),
      'file' => "$mod_path/includes/splash.inc",
    );
    $derivatives = array_merge($derivatives, islandora_scholar_get_derivatives());
  }

  return $derivatives;
}

/**
 * Grab models used to represent citations.
 *
 * @return array
 *   An array of strings representing content model PIDs.
 */
function boston_college_citation_models() {
  return array(
    'ir:citationCModel',
    'ir:thesisCModel',
    'ir:undergraduateETDCModel',
    'ir:graduateETDCModel',
  );
}

/**
 * Implements hook_islandora_datastream_purged().
 */
function boston_college_islandora_datastream_purged(AbstractObject $object, $dsid) {
  $models = boston_college_citation_models();
  $purge_derived_dsids = array(
    BOSTON_COLLEGE_ARCHIVAL_PDF_DATASTREAM_ID,
    'PDF',
  );

  if (!(in_array($dsid, $purge_derived_dsids) && array_intersect($models, $object->models))) {
    return;
  }

  module_load_include('inc', 'islandora', 'includes/utilities');
  $hooks = islandora_invoke_hook_list(ISLANDORA_DERVIATIVE_CREATION_HOOK, $object->models, array($object));

  $hook_filter = function ($hook_def) use ($purge_derived_dsids) {
    return isset($hook_def['source_dsid']) && isset($hook_def['destination_dsid']) ?
      in_array($hook_def['source_dsid'], $purge_derived_dsids) :
      FALSE;
  };
  $hooks = array_filter($hooks, $hook_filter);

  $dsid_map = function ($hook_definition) {
    return $hook_definition['destination_dsid'];
  };

  $dsids = array_map($dsid_map, $hooks);
  array_map(array($object, 'purgeDatastream'), $dsids);
}

/**
 * Implements hook_menu().
 */
function boston_college_menu() {
  $items = array();

  $items['admin/islandora/boston_college'] = array(
    'title' => 'Boston College Configuration',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('boston_college_admin_settings_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/admin.form.inc',
  );

  return $items;
}

/**
 * Implements islandora_required_objects().
 */
function boston_college_islandora_required_objects(IslandoraTuque $connection) {
  $module_path = drupal_get_path('module', 'boston_college');
  // Video Content Model.
  $video_content_model = $connection->repository->constructObject(BOSTON_COLLEGE_VIDEO_CONTENT_MODEL);
  $video_content_model->owner = 'fedoraAdmin';
  $video_content_model->label = 'Boston College Video Content Model';
  $video_content_model->models = 'fedora-system:ContentModel-3.0';
  // DS-COMPOSITE-MODEL Datastream.
  $datastream = $video_content_model->constructDatastream('DS-COMPOSITE-MODEL', 'X');
  $datastream->label = 'DS-COMPOSITE-MODEL';
  $datastream->mimetype = 'application/xml';
  $datastream->setContentFromFile("$module_path/xml/boston_college_video_ds_composite.xml", FALSE);
  $video_content_model->ingestDatastream($datastream);

  return array(
    'boston_college' => array(
      'title' => 'Boston College',
      'objects' => array(
        $video_content_model,
      ),
    ),
  );
}

/**
 * Implements islandora_xml_form_builder_forms().
 */
function boston_college_islandora_xml_form_builder_forms() {
  return array(
    BOSTON_COLLEGE_VIDEO_FORM => array(
      'form_file' => drupal_get_path('module', 'boston_college') . '/xml/bc_video_mods_form.xml',
    ),
  );
}

/**
 * Implements hook_islandora_xml_form_builder_form_associations().
 */
function boston_college_islandora_xml_form_builder_form_associations() {
  return array(
    'boston_college_video_mods_form' => array(
      'content_model' => BOSTON_COLLEGE_VIDEO_CONTENT_MODEL,
      'form_name' => BOSTON_COLLEGE_VIDEO_FORM,
      'dsid' => 'MODS',
      'title_field' => array('titleInfo', 'title'),
      'transform' => 'mods_to_dc.xsl',
      'template' => FALSE,
    ),
  );
}

/**
 * Implements hook_islandora_CMODEL_PID_ingest_steps().
 */
function boston_college_islandora_BCVideo_islandora_ingest_steps() {
  return array(
    'boston_college_upload' => array(
      'weight' => 10,
      'type' => 'form',
      'form_id' => 'boston_college_video_upload_form',
      'module' => 'boston_college',
      'file' => 'includes/video_upload.form.inc',
    ),
  );
}

/**
 * Implements hook_CMODEL_PID_derivative().
 */
function boston_college_islandora_BCVideo_islandora_derivative() {
  return array(
    array(
      'source_dsid' => 'OBJ',
      'destination_dsid' => 'TN',
      'weight' => '0',
      'function' => array(
        'islandora_video_create_thumbnail',
      ),
      'file' => drupal_get_path('module', 'islandora_video') . '/includes/derivatives.inc',
    ),
    array(
      'source_dsid' => 'MODS',
      'destination_dsid' => 'STREAM',
      'weight' => '0',
      'function' => array(
        'boston_college_create_stream',
      ),
      'file' => drupal_get_path('module', 'boston_college') . '/includes/derivatives.inc',
    ),
  );
}

/**
 * Implements hook_islandora_view_object().
 */
function boston_college_islandora_view_object(AbstractObject $object) {
  if (array_intersect(array('ir:undergraduateETDCModel', 'ir:graduateETDCModel'), $object->models)) {
    module_load_include('inc', 'islandora_scholar', 'includes/utilities');
    return islandora_scholar_get_view($object);
  }
}

/**
 * Implements hook_theme().
 */
function boston_college_theme($existing, $type, $theme, $path) {
  return array(
    'boston_college_video' => array(
      'variables' => array('object' => NULL),
      'file' => 'theme/theme.inc',
    ),
  );
}

/**
 * Implements hook_CMODEL_PID_islandora_view_object().
 */
function boston_college_islandora_BCVideo_islandora_view_object(AbstractObject $object) {
  return array(theme('boston_college_video', array('object' => $object)));
}

/**
 * Adds a table to track Handles that need to be modified during the migration.
 */
function boston_college_update_7000() {
  $schema['boston_college_handles'] = array(
    'fields' => array(
      'handle' => array(
        'type' => 'varchar',
        'length' => 128,
        'not null' => TRUE,
      ),
      'islandora_pid' => array(
        'type' => 'varchar',
        'length' => 128,
        'not null' => TRUE,
      ),
      'digitool_pid' => array(
        'type' => 'varchar',
        'length' => 128,
        'not null' => FALSE,
      ),
      'old_url' => array(
        'type' => 'varchar',
        'length' => 128,
        'not null' => FALSE,
      ),
      'updated' => array(
        'type' => 'int',
        'size' => 'tiny',
        'not null' => TRUE,
        'default' => 0,
      ),
    ),
    'primary key' => array('handle'),
  );
  db_create_table('boston_college_handles', $schema['boston_college_handles']);
  return t('Created table to track Handles.');
}
